<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="./css/admin_dashboard.css">
</head>
<body>
  <h1>Admin Dashboard</h1>
  <button id="logout-btn">
    <a href="./login.html" style="text-decoration: none; color: white;">Logout</a>
  </button>

  <table id="bookings-table">
    <thead>
      <tr>
        <th>User</th>
        <th>Car</th>
        <th>Pickup</th>
        <th>Dropoff</th>
        <th>Dates</th>
        <th>Price</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const tbody = document.querySelector("#bookings-table tbody");

  async function loadBookings() {
    try {
      const res = await fetch("http://localhost:3000/api/admin/bookings");
      const bookings = await res.json();
      tbody.innerHTML = "";

      bookings.forEach(b => {
        // Normalize status for comparison
        const status = (b.status || "").toLowerCase().trim();

        let actions = "";

        // Show cancel button for booked
        if (status === "booked" || status === "active") {
          actions = `<button class="cancel-btn" onclick="cancelBooking('${b._id}')">Cancel</button>`;
        }
        // Show delete button for cancelled/canceled
        else if (status === "cancelled" || status === "canceled") {
          actions = `<button class="delete-btn" onclick="deleteBooking('${b._id}')">Delete</button>`;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${b.username}</td>
          <td>${b.carName}</td>
          <td>${b.pickupLocation}</td>
          <td>${b.dropoffLocation}</td>
          <td>${b.pickupDate} - ${b.dropoffDate}</td>
          <td>${b.totalPrice}</td>
          <td style="text-transform: capitalize;">${b.status}</td>
          <td>${actions}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error("Failed to load bookings:", error);
    }
  }

  async function cancelBooking(id) {
    const confirmed = confirm("Are you sure you want to cancel this booking?");
    if (!confirmed) return;

    await fetch("http://localhost:3000/api/cancel", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookingId: id })
    });

    alert("Booking cancelled successfully!");
    loadBookings();
  }

  async function deleteBooking(id) {
    const confirmed = confirm("Are you sure you want to permanently delete this cancelled booking?");
    if (!confirmed) return;

    await fetch("http://localhost:3000/api/delete", {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookingId: id })
    });

    alert("Cancelled booking deleted successfully!");
    loadBookings();
  }

  loadBookings();
</script>

</body>
</html>
